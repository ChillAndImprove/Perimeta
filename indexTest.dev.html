<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=5,IE=9" ><![endif]-->
<!DOCTYPE html>
<html>
<head>
    <title>Threagile+</title> <!-- Note: Title differs from index.html -->
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<!-- Project specific styles -->
	<link rel="stylesheet" type="text/css" href="styles/grapheditor.css">
	<!-- Assuming tagify.css is already local in this version -->
	<link rel="stylesheet" type="text/css" href="styles/tagify.css">

	<!-- Keep WASM preload -->
	<link rel="preload" href="main.wasm" as="fetch" type="application/wasm">

    <!-- Load the bundled JS containing pako, lodash, yaml, tagify -->
    <!-- This replaces the individual script tags for those libraries -->
    <script type="module" src="dist/bundle.js" defer></script>

	<script type="text/javascript">
	    // Initial inline script (remains unchanged)
	    window.addEventListener('load', function() {
		var logo = document.getElementById('logo');
	//	logo.classList.remove('image-fade-out-transition');
	    });
	</script>
    <!-- === START AUTO-GENERATED IMPORT MAP === -->
<!-- The content between these markers will be automatically replaced -->
<!-- Run `deno task generate-map` to update -->
<script type="importmap">
{
    "imports": {
        "pako": "https://esm.sh/pako",
        "lodash": "https://esm.sh/lodash-es",
        "yaml": "https://esm.sh/yaml",
        "@yaireo/tagify": "https://esm.sh/@yaireo/tagify@4.34.0",
        "sweetalert2": "https://esm.sh/sweetalert2@11",
        "dompurify": "https://esm.sh/dompurify",
        "raphael": "https://esm.sh/raphael",
        "justgage": "https://esm.sh/justgage",
        "@hpcc-js/wasm": "https://esm.sh/@hpcc-js/wasm@^2",
        "@ts-graphviz/parser": "https://esm.sh/@ts-graphviz/parser@^0.6"
    }
}
</script>
<!-- === END AUTO-GENERATED IMPORT MAP === -->

	<!-- Inline styles (remain unchanged) -->
	<style type="text/css">
	</style>
	<style type="text/css">
	.pipeFlowAnimation {
	  stroke-dasharray: 8;
	  /* Note: Animation duration differs from index.html */
	  animation: pipeFlowKeyframes 0.0s linear;
	  animation-iteration-count: infinite;
	}
	@keyframes pipeFlowKeyframes {
	  to {
	    stroke-dashoffset: -16;
	  }
	}
	</style>
	<style type="text/css">
    .image-fade-out-transition {
        opacity: 1;
        /* Note: Transition duration differs from index.html */
        transition: opacity 0s ease-out;
    }
    </style>
    <script type="text/javascript">
    // Logo fade out script (remains unchanged, though timeout values differ)
    window.addEventListener('load', function() {
        var logo = document.getElementById('logo_tiger');
        setTimeout(function() {
            logo.style.transition = 'opacity 2s ease-out';
            logo.style.opacity = '0';

            /* Note: Timeout values differ from index.html */
            setTimeout(function() {
                logo.style.display = 'none';
            }, 1);
        }, 1);
    });
    </script>
    <style type="text/css">
    #logo_tiger {
        position: relative;
        justify-content: center;
        margin: 0 auto;
        height: auto;
        z-index: 999;
        width: 600px;
        display: flex;
    }
    </style>
    <!-- End Inline styles/scripts -->


    <!-- Keep necessary legacy scripts -->
	<script src="wasm_exec.js"></script>
    <script type="module" src="./app.js" defer></script>


	<script type="text/javascript">
		// Parses URL parameters (remains unchanged)
		var urlParams = (function(url)
		{
			var result = new Object();
			var idx = url.lastIndexOf('?');

			if (idx > 0)
			{
				var params = url.substring(idx + 1).split('&');

				for (var i = 0; i < params.length; i++)
				{
					idx = params[i].indexOf('=');

					if (idx > 0)
					{
						result[params[i].substring(0, idx)] = params[i].substring(idx + 1);
					}
				}
			}

			return result;
		})(window.location.href);

		// Default resources are included in grapheditor resources (remains unchanged)
		mxLoadResources = false;
        // Define globals needed by mxClient.js et al. (if not already defined elsewhere)
        // Ensure these are set correctly for your mxGraph setup
        var RESOURCE_BASE = 'resources/grapheditor'; // Adjust if needed
        var STYLE_PATH = 'styles'; // Adjust if needed
        var IMAGE_PATH = 'images'; // Adjust if needed
        var STENCIL_PATH = 'stencils'; // Adjust if needed
        // var mxLanguage = urlParams['lang']; // Example: If language is needed early
        // var VSD_CONVERT_URL = '/convert'; // Example
        // var EXPORT_URL = '/export'; // Example
        // var OPEN_URL = '/open'; // Example
	</script>

    <!-- Core mxGraph and other remaining legacy scripts -->
	<script type="text/javascript" src="js/Init.js"></script>
	<script type="text/javascript" src="js/mxClient.js"></script>
	<script type="module" src="js/EditorUi.js"></script>
	<script type="text/javascript" src="js/Editor.js"></script>
	<script type="text/javascript" src="js/Sidebar.js"></script>
	<script type="text/javascript" src="js/Graph.js"></script>
	<script type="module" src="js/Format.js"></script>
	<script type="text/javascript" src="js/Shapes.js"></script>
	<script type="text/javascript" src="js/Actions.js"></script>
	<script type="module" src="js/Menus.js"></script>
	<script type="module" src="js/Toolbar.js"></script>
	<script type="text/javascript" src="js/Dialogs.js"></script>
    <script type="module" src="js/bootstrap.js"></script>
</head>
<body class="geEditor">
	<img src="images/logo.png" id="logo_tiger" class="image-fade-out-transition">

	<!-- Main application initialization script (remains unchanged) -->
    <!-- Note: Timeout value differs from index.html -->
	<script type="module">
		window.addEventListener('load', function() {
		    setTimeout(function() {
				(function()
				{
					var editorUiInit = window.EditorUi.prototype.init;

					window.EditorUi.prototype.init = function()
					{
						editorUiInit.apply(this, arguments);
                        // This section might need adjustment based on how OPEN_URL/backend checks are handled
                        // For now, keeping original logic:
						this.actions.get('export').setEnabled(false);

						// Updates action states which require a backend
						if (!Editor.useLocalStorage)
						{
                            // Check if OPEN_URL is defined before using it
                            if (typeof OPEN_URL !== 'undefined') {
							    mxUtils.post(OPEN_URL, '', mxUtils.bind(this, function(req)
							    {
								    var enabled = req.getStatus() != 404;
								    this.actions.get('open').setEnabled(enabled || Graph.fileSupport);
								    this.actions.get('import').setEnabled(enabled || Graph.fileSupport);
								    this.actions.get('save').setEnabled(enabled);
								    this.actions.get('saveAs').setEnabled(enabled);
								    this.actions.get('export').setEnabled(enabled);
							    }));
                            } else {
                                console.warn("OPEN_URL is not defined. File operations requiring a backend may be disabled.");
                            }
						}
					};

					// Adds required resources (disables loading of fallback properties, this can only
					// be used if we know that all keys are defined in the language specific file)
					mxResources.loadDefaultBundle = false;
                    // Ensure RESOURCE_BASE and mxLanguage are defined
                    var mxLanguage = urlParams['lang'] || 'en'; // Default language if not in URL
					var bundle = mxResources.getDefaultBundle(RESOURCE_BASE, mxLanguage) ||
						mxResources.getSpecialBundle(RESOURCE_BASE, mxLanguage);

                    // Ensure STYLE_PATH is defined
					// Fixes possible asynchronous requests
					mxUtils.getAll([bundle, STYLE_PATH + '/default.xml'], function(xhr)
					{
						// Adds bundle text to resources
						mxResources.parse(xhr[0].getText());

						// Configures the default graph theme
						var themes = new Object();
						themes[Graph.prototype.defaultThemeName] = xhr[1].getDocumentElement();

						// Main EditorUi Initialization
                        console.log("Initializing EditorUi...");
						new window.EditorUi(new Editor(urlParams['chrome'] == '0', themes));
                        console.log("EditorUi Initialized.");

					}, function()
					{
						document.body.innerHTML = '<center style="margin-top:10%;">Error loading resource files. Please check browser console.</center>';
					});
				})();
		    }, 0); // Note: Timeout value differs from index.html
		});
	</script>
</body>
</html>

    

